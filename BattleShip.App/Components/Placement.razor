@inject GameState GameState
@using BattleShip.Models

<div class="container-placement">

	@* les différents bateaux à placer *@
	<div class="list-boat">
		
		@if(GameState.fleetJ1 != null)
		{
			@foreach (var boat in GameState.fleetJ1.Boats)
			{
				<p class="@(boat.IsAlive ? "alive" : "sunk")">
					@boat.Name - @boat.Size
				</p>

				@if(!clic & !IsPlaced(boat.Symbol))
				{
					@if(!IsPlaced(boat.Symbol))
					{
						<button class="btn btn-primary" @onclick="() => SelectBoat(boat)" >
							Add
						</button>
					}
					else {
						<button class="btn btn-danger" @onclick="() => DeleteBoat(boat)" >
							Suppr
						</button>
					}
					
				}
				
			}
		}

	</div>


	@* Notre grille de placement *@
	<div class="placement-grid">
		<div class="sub-title">
			<h3>Placement</h3>
		</div>
		<div class="grid-container">
			@if (1 != 0)
			{
				@for (int row = 0; row < GameState.GridJ1.Length; row++)
				{
					var currentRow = row;
					<div class="grid-row pos-{row}">
						@for (int col = 0; col < GameState.GridJ1[0].Length; col++)
						{
							var currentCol = col;
							<div class="grid-item pos-{row}-{col} pos-{col}" @onclick="() => AddBoatToGrid(currentRow, currentCol)">
								<div class="grid-item pos-{row}-{col} pos-{col}">
									@GetImageForCell(GameState.GridJ1,GameState.MaskedGridJ1, row, col)
								</div>
							</div>
						}
					</div>
				}
			}
		</div>
	</div>

</div>


<div>
	<button class="btn btn-primary" @onclick="() => OnButtonClicked()">
		Start
	</button>
</div>


@code {

	private bool clic;
	private Boat boatSelected;

	[Parameter]
	public EventCallback OnCallStart { get; set; }

	private async Task OnButtonClicked()
	{
		if (OnCallStart.HasDelegate)
		{
			await OnCallStart.InvokeAsync();
		}
	}


	private void SelectBoat(Boat boat)
	{
		clic = true;
		boatSelected = boat;
	}


	private void AddBoatToGrid(int row, int col)
    {
		if(clic)
		{
			Console.WriteLine(row);
			Console.WriteLine(col);
			GameState.GridJ1[row][col] = boatSelected.Symbol;
			boatSelected.X = row;
			boatSelected.Y = col;
			clic = false;
		}
		
    }

	private void DeleteBoat(Boat boat)
	{
		boat.X = -1;
		boat.Y = -1;
	}


	private bool IsPlaced(char symbol)
{
    for (int row = 0; row < GameState.GridJ1.Length; row++)
    {
        for (int col = 0; col < GameState.GridJ1[row].Length; col++)
        {
            if (GameState.GridJ1[row][col] == symbol)
            {
                return true; 
            }
        }
    }
    return false;
}




	private MarkupString GetImageForCell(char[][] grid, bool?[][] maskeGrid, int x, int y)
	{

		string imageUrl = "";
		string rotationClass = "";

		// taille de la grille
		int numberOfRows = grid.Length;
		int numberOfColumns = grid[0].Length;


		// cas ou il y a un bateau
		if (grid[x][y] != '\0')
		{
			if(maskeGrid[x][y] == null || maskeGrid[x][y] == true)
			{
				// lettre du bateau
				char letter = grid[x][y];

				// si lettre a gauche et a droite => midle
				if (y > 0 && y < numberOfColumns-1 && grid[x][y-1] == letter && grid[x][y+1] == letter){
					imageUrl = "img/middle_boat";
					rotationClass = "rotate-90";
				}
				// sinon si lettre a gauche => last
				else if (y > 0 && grid[x][y-1] == letter){
					imageUrl = "img/front_boat";
					rotationClass = "rotate-90";
				}
				// sinon si lettre a droite => first
				else if (y < numberOfColumns-1 && grid[x][y+1] == letter){
					imageUrl = "img/back_boat";
					rotationClass = "rotate-90";
				}
				// si lettre en haut et en bas => midle
				else if (x > 0 && x < numberOfRows-1 && grid[x-1][y] == letter && grid[x+1][y] == letter){
					imageUrl = "img/middle_boat";
				}
				// sinon si lettre en haut => front
				else if (x > 0 && grid[x-1][y] == letter){
					imageUrl = "img/back_boat";
				}
				// sinon si lettre en bas => last
				else if (x < numberOfRows-1 && grid[x+1][y] == letter){
					imageUrl = "img/front_boat";
				}
				else {
					imageUrl = "img/single_boat";
				}
			}
			
			if(maskeGrid[x][y] == true)
			{
				imageUrl += "_hit";
			}
		}
		// cas ou il n'y a pas de bateau
		else {

			if(maskeGrid[x][y] == false)
			{
				imageUrl = "img/miss";
			}
			else {
				return new MarkupString($"<span></span>");
			}
		}
		
		imageUrl += ".png";
		return new MarkupString($"<img src='{imageUrl}' alt='cell-image' class='img-grid {rotationClass}' />");
	}
}